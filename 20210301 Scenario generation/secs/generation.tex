\section{Scenario generation}
\label{sec:generation}

To generate realistic scenarios for the assessment of \acp{av}, we will use a data-driven approach: observed scenarios are used to generate new scenarios.
To do this, we will parameterize the scenarios and estimate \iac{pdf} of the parameters.
However, choosing the parameters that describe a scenario is not trivial:
\begin{itemize}
	\item Choosing too few parameters might lead to an oversimplification of the actual scenarios.
	As a result, not all possible varieties of a scenario will be modeled.
	
	\item Too many parameters lead to problems with estimating the \ac{pdf}, due to the curse of dimensionality \autocite{scott1992multivariate}.
\end{itemize}
To overcome this problem, we will first consider many parameters to avoid the oversimplification of the scenarios. 
Next, using \iac{svd}, we will create a new set of parameters using a linear mapping of the original scenario parameters.
Because this new set of parameters is ordered according to the contribution of each of these parameters in describing the variation that exists among the original scenario parameters, we will consider only the most important parameters without losing too much information.
In this way, we will avoid the curse of dimensionality without relying on a predetermined choice of parameters.

First, we will explain how to describe a scenario using many parameters.
Next, in \cref{sec:svd}, we will propose the use of \iac{svd} to reduce the number of parameters.
In \cref{sec:kde}, we will describe how \ac{kde} is used to estimate the \ac{pdf} of the reduced set of parameters and how the estimated \ac{kde} can be used to generate new scenarios.



\subsection{Parameterization of scenarios}
\label{sec:parameterization}

The first step of our approach is the parameterization of scenarios.
There is, however, no single best way to parameterize the scenarios considering the wide variety of scenarios.
To deal with this variety, we distinguish quantitative scenarios from qualitative scenarios, using the definitions of \emph{scenario} and \emph{scenario category} of \autocite{degelder2020ontology}:

\begin{definition}[Scenario]
	\label{def:scenario}
	A scenario is a quantitative description of the relevant characteristics and activities and/or goals of the ego vehicle(s), the static environment, the dynamic environment and all events that are relevant to the ego vehicle(s) within the time interval between the first and last relevant event.
\end{definition}

\begin{definition}[Scenario category]
	\label{def:scenario category}
	A scenario category is a qualitative description of relevant characteristics and activities and/or goals of the ego vehicle(s), the static environment, and the dynamic environment.
\end{definition}

A scenario category is an abstraction of a scenario and, therefore, a scenario category comprises multiple scenarios \autocite{degelder2020ontology}.
For example, the scenario category ``cut in'' comprises all possible cut-in scenarios.
The goal of our approach is to generate scenarios based on a set of observed scenarios, such that the generated scenarios are comprised by the same scenario category that comprises the observed scenarios.

We assume that all observed scenarios, that are comprised by the same scenario category, can be described using a time series and some additional parameters.
Here, we denote the time series of a scenario by $\timeseries{\time} \in \realnumbers^{\dimensiontimeseries}$ with $\time \in [\timestart, \timeend]$, where $\dimensiontimeseries$ denotes the dimension of the time series and $\timestart$ and $\timeend$ denote the start and end time of the scenario.
The $\dimensionextraparameters$ additional parameters are represented by $\extraparameters \in \realnumbers^{\dimensionextraparameters}$.

To deal with the time series, we discretize the time continuous time interval $[\timestart, \timeend]$, such that two consecutive time instants are $(\timeend - \timestart) / \numberoftimesegments$ apart. 
This gives us:
\begin{equation}
	\label{eq:time series vectorized}
	\timeseriesvec = \begin{bmatrix}
		\timeseries{\timestart} \\ 
		\timeseries{\timestart + \frac{\timeend - \timestart}{\numberoftimesegments}} \\
		\timeseries{\timestart + 2\frac{\timeend - \timestart}{\numberoftimesegments}} \\
		\vdots \\
		\timeseries{\timeend}
	\end{bmatrix} \in \realnumbers^{\left( \numberoftimesegments + 1 \right) \dimensiontimeseries}.
\end{equation}
Discretizing the time series of a scenario in this way ensures that the number of parameters of a scenario is independent of the duration of a scenario. 
Note that $\numberoftimesegments$ must be chosen such that no important information is lost during the discretization.
Because in practice the time series $\timeseries{\time}$ is obtained at certain specific times rather than on a continuous time interval, it may be required to use interpolation techniques, such as splines \autocite{deboor1978practical}, to evaluate $\timeseriesvec$.

Let us assume that we have $\scenariosnumberof$ observed scenarios that we can use to generate new scenarios. 
To indicate the the scenario parameters $\timeseriesvec$ and $\extraparameters$ belong to a specific scenario, we will use the index $\scenarioindex \in \{1,\ldots,\scenariosnumberof\}$. 
I.e., the parameters of the $\scenarioindex$-th scenario are $\timeseriesvec_{\scenarioindex}$ and $\extraparameters_{\scenarioindex}$.
To further ease the notation, we will combine $\timeseriesvec_{\scenarioindex}$ and $\extraparameters_{\scenarioindex}$ into one vector $\scenariopars_{\scenarioindex}$:
\begin{equation}
	\label{eq:scenario parameters}
	\scenariopars_{\scenarioindex} = \begin{bmatrix}
		\timeseriesvec_{\scenarioindex} \\ \extraparameters_{\scenarioindex}
	\end{bmatrix} \in \realnumbers^{\left( \numberoftimesegments + 1 \right) \dimensiontimeseries + \dimensionextraparameters}.
\end{equation}



\subsection{Parameter reduction using a \acl{svd}}
\label{sec:svd}

As shown in \cref{eq:scenario parameters}, we describe a scenario with $\dimensionscenariopars = \left( \numberoftimesegments + 1 \right) \dimensiontimeseries + \dimensionextraparameters$ parameters.
Even for small numbers of $\numberoftimesegments$, $\dimensiontimeseries$, and $\dimensionextraparameters$, the total number of parameters become too many to reliably estimate the joint \ac{pdf}.
One way to avoid the curse of dimensionality is to assume that the parameters are independent, but especially the parameters that describe the time series in \cref{eq:time series vectorized} are obviously correlated, so this is not a good solution.

In the field of machine learning, \ac{pca} is commonly used for dimensionality reduction \autocite{abdi2010principal}.
As \ac{pca} uses the \ac{svd} \autocite{golub2013matrix}, we will use \iac{svd} to transform the parameters $\scenariopars_{\scenarioindex}$ into a lower-dimensional vector of parameters.
Before applying the \ac{svd}, we weigh the parameters with $\weights \in \realnumbers^{\dimensionscenariopars}$.
Let us define a matrix that contains the parameters of the $\scenariosnumberof$ scenarios:
\begin{equation}
	\scenarioparsmatrix = \begin{bmatrix}
		\weights\scenariopars_1-\svdmean & \ldots & \weights\scenariopars_{\scenariosnumberof}-\svdmean
	\end{bmatrix} \in \realnumbers^{\dimensionscenariopars \times \scenariosnumberof},
\end{equation}
where $\svdmean$ denotes the mean of the weighted scenario parameters:
\begin{equation}
	\svdmean = \frac{1}{\scenariosnumberof} \sum_{\scenarioindex=1}^{\scenariosnumberof} \weights \scenariopars_{\scenarioindex}.
\end{equation}

Using the \ac{svd} of $\scenarioparsmatrix$, we obtain:
\begin{equation}
	\label{eq:svd}
	\scenarioparsmatrix = \svdu \svds \svdv^T.
\end{equation}
Here, $\svdu \in \realnumbers^{\dimensionscenariopars \times \dimensionscenariopars}$ and $\svdv \in \realnumbers^{\scenariosnumberof \times \scenariosnumberof}$ are orthonormal matrices, i.e., $\svdu^{-1}=\svdu^T$ and $\svdv^{-1}=\svdv^T$.
Moreover, $\svds \in \realnumbers^{\dimensionscenariopars \times \scenariosnumberof}$ takes the same shape as $\scenarioparsmatrix$ and has only zeros except at the diagonal; the $(\svdindex,\svdindex)$-th element is $\svdsv{\svdindex}$, $\svdindex\in\{1,\ldots,\svdrank\}$, $\svdrank = \min(\dimensionscenariopars,\scenariosnumberof)$, such that 
\begin{equation}
	\svdsv{1} \geq \svdsv{2} \geq \ldots \geq \svdsv{\svdrank} \geq 0.
\end{equation}
Because these so-called singular values are in decreasing order, we can approximate $\scenariopars_{\scenarioindex}$ by setting $\svdsv{\svdindex}=0$ for $\svdindex > \dimension$:
\begin{equation}
	\label{eq:svd approximation}
	\weights \scenariopars_{\scenarioindex} 
	= \svdmean + \sum_{\svdindex=1}^{\svdrank} \svdsv{\svdindex} \svdventry{\scenarioindex}{\svdindex} \svduvec{\svdindex}
	\approx \svdmean + \sum_{\svdindex=1}^{\dimension} \svdsv{\svdindex} \svdventry{\scenarioindex}{\svdindex} \svduvec{\svdindex},
\end{equation}
where $\svdventry{\scenarioindex}{\svdindex}$ is the $(\scenarioindex,\svdindex)$-th element of $\svdv$ and $\svduvec{\svdindex}$ is the $\svdindex$-th column of $\svdu$.

\begin{remark}
	Using the approximation of \cref{eq:svd approximation}, it is not necessary to evaluate the complete \ac{svd} of \cref{eq:svd}.
	Only the first $\dimension$ columns of $\svdu$ and $\svdv$ need to be computed and only the first $\dimension$ singular values. 
	In practice, $\dimension \ll \svdrank$, so this saves a significant amount of computation time.
\end{remark}

The choice of $\dimension < \svdrank$ is not trivial.
Choosing $\dimension$ too small results in too much loss of detail.
Choosing $\dimension$ too large will give problems when estimating the \ac{pdf}.
One method to choose $\dimension$ is to look at the amount of overall variance explained by the first $\dimension$ singular values.
The overall variance scales with the sum of the squared singular values \autocite[p.~77]{golub2013matrix}, i.e., we have
\begin{equation}
	\sum_{\scenarioindex=1}^{\scenariosnumberof} \left( \weights\scenariopars_{\scenarioindex}-\svdmean \right)^T \left( \weights\scenariopars_{\scenarioindex}-\svdmean \right) 
	= \sum_{\svdindex=1}^{\svdrank} \svdsv{\svdindex}^2.
\end{equation}
Thus, if we consider the first $\dimension$ singular values, we ``explain''
\begin{equation}
	\label{eq:explained variance}
	\frac{\sum_{\svdindex=1}^{\dimension} \svdsv{\svdindex}^2}{\sum_{\svdindex=1}^{\svdrank} \svdsv{\svdindex}^2}
\end{equation}
of the overall variance.
One approach would be to set $\dimension$ such that \cref{eq:explained variance} exceeds a certain threshold, such as 0.95.
In \cref{sec:comparison}, we will propose an alternative way to determine $\dimension$ using a metric that quantifies the goal of our generated scenarios, i.e., that the generated scenarios are representing real-world scenarios and cover the actual variety of real-world scenarios.



\subsection{Estimating the \acl{pdf}}
\label{sec:kde}

Using the approximation of \cref{eq:svd approximation} based on the \ac{svd}, the $\scenarioindex$-th scenario is described by the vector $\svdvvecd{\scenarioindex}$:
\begin{equation}
	\svdvvecd{\scenarioindex}^T = \begin{bmatrix}
		\svdventry{\scenarioindex}{1} & \ldots & \svdventry{\scenarioindex}{\dimension}
	\end{bmatrix}.
\end{equation}
Note that the $\dimension$ entries of $\svdvvecd{\scenarioindex}$ are linearly uncorrelated because of the orthonormality of $\svdv$.
Higher-order correlations, however, are still present, so we treat these $\dimension$ entries as dependent variables.

To estimate the \ac{pdf} of $\svdvvecd{\scenarioindex}$, we propose to use \ac{kde}.
\ac{kde} \autocite{rosenblatt1956remarks, parzen1962estimation} is often referred to as a non-parametric way to estimate the \ac{pdf}, because no use is made of a predefined functional form of the \ac{pdf} for which certain parameters are fitted to the data.
Because \ac{kde} produces \iac{pdf} that adapts itself to the data, it is flexible regarding the shape of the actual underlying distribution of $\svdvvecd{\scenarioindex}$.
In \ac{kde}, the \ac{pdf} is estimated as follows:
\begin{equation}
	\label{eq:density est kde}
	\densityestkde{\bandwidthmatrix}{\scenarioparsreduced} = \frac{1}{\scenariosnumberof} 
	\sum_{\scenarioindex=1}^{\scenariosnumberof} \kernelfuncnormalized{\bandwidthmatrix}{\scenarioparsreduced - \svdvvecd{\scenarioindex}}.
\end{equation}
Here, $\kernelfuncnormalized{\bandwidthmatrix}{\cdot}$ is the so-called scaled kernel with a positive definite symmetric bandwidth matrix $\bandwidthmatrix \in \realnumbers^{\dimension \times \dimension}$.
The kernel $\kernelfunc{\cdot}$ and the scaled kernel $\kernelfuncnormalized{\bandwidthmatrix}{\cdot}$ are related using
\begin{equation}
	\kernelfuncnormalized{\bandwidthmatrix}{\dummyvar} = \left|\bandwidthmatrix\right|^{-1/2} \kernelfunc{\bandwidthmatrix^{-1/2} \dummyvar},
\end{equation}
where $|\cdot|$ denotes the matrix determinant. 
The choice of the kernel function is not as important as the choice of the bandwidth matrix \autocite{turlach1993bandwidthselection, duong2007ks}.
In this paper, we use a Gaussian kernel, but our method for generating scenarios also applies for other kernels. 
The Gaussian kernel is given by
\begin{equation}
	\kernelfunc{\dummyvar} = \frac{1}{\left(2\pi\right)^{\dimension/2}} \e{-\frac{1}{2} \normtwo{\dummyvar}^2},
\end{equation}
where $\normtwo{\dummyvar}^2$ denotes the squared 2-norm of $\dummyvar$; i.e., $\dummyvar^T \dummyvar$.

To sample scenario parameters using $\densityestkde{\bandwidthmatrix}{\cdot}$, first, an integer $\scenarioindex \in \{1,\ldots,\scenariosnumberof\}$ is randomly chosen with each integer having equal likelihood. 
Next, a random sample is drawn from a Gaussian with covariance $\bandwidthmatrix$ and mean $\svdvvecd{\scenarioindex}$.
Then, using the approximation in \cref{eq:svd approximation}, the scenario parameters are calculated.
