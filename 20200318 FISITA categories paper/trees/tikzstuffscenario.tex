\newlength{\hwidth}\setlength{\hwidth}{4.22em}
\definecolor{TNOlightgray}{RGB}{222,222,231}
\tikzstyle{tag}=[text height=.8em, text depth=.1em, font=\small\sffamily, rounded corners=0.2em, fill=TNOlightgray, node distance=9em, text width=2\hwidth-2em, align=center]
\tikzstyle{tag wide}=[tag, text width=11em]
\tikzstyle{tag next to wide}=[tag, node distance=10.5em]
\tikzstyle{tagemphasize}=[]
\tikzstyle{tagarrow}=[->, line width=0.75mm, color=TNOlightgray]
\tikzstyle{number}=[node distance=\hwidth, text width=1em, align=left]
\newcounter{tmpcounter}
\newcounter{tmpcounter2}


\ExplSyntaxOn
\newcommand{\showtag}[3]{
	\StrLeft{#3}{1}[\firstchar]
	\IfStrEq{\firstchar}{*}{
		\node[#1, tagemphasize](#2){\StrGobbleLeft{#3}{1}};
	}{
		\node[#1](#2){#3};
	}
}

\NewDocumentCommand{\rowtags}{O{,}mm}{
	\setcounter{tmpcounter}{0}
	\seq_set_split:Nnn \arg { #1 } { #2 }
	\seq_pop_left:NN \arg \argl
	\begin{tikzpicture}
	\node[tag~wide](A){\argl};
	\node[number, left~of=A, node~distance=6.5em]{#3.};
	
	\ifnum \seq_count:N \arg > 0
	\seq_pop_left:NN \arg \argl
	\setcounter{tmpcounter2}{\value{tmpcounter}}
	\stepcounter{tmpcounter}
	\showtag{tag~next~to~wide, right~of=A}{tag\arabic{tmpcounter}}{\argl};
	\draw[tagarrow] (A) -- (tag\arabic{tmpcounter});
	
	\seq_map_inline:Nn \arg {
		\setcounter{tmpcounter2}{\value{tmpcounter}}
		\stepcounter{tmpcounter}
		\node[tag, below~of=tag\arabic{tmpcounter2}, node~distance=2em, xshift=1em](tag\arabic{tmpcounter}){##1};
		\node[coordinate, left~of=tag\arabic{tmpcounter}, node~distance=\hwidth, yshift=1.2em](tag\arabic{tmpcounter} helper){};
		\draw[tagarrow] (tag\arabic{tmpcounter} helper) |- (tag\arabic{tmpcounter});
	}
	\fi
	\end{tikzpicture}
}

\newcounter{tagbcounter}
\newcounter{tagccounter}
\newcommand{\taga}[1]{
	\showtag{tag~wide}{taga}{#1};
	\node[coordinate, below~of=taga, node~distance=2em](helper){};
}
\newcommand{\tagb}[3]{
	\showtag{tag, below~of=taga, node~distance=4em, xshift=#3}{tagb#2}{#1};
	\draw[tagarrow] (taga) -- (helper) -| (tagb#2);
	\node[coordinate, xshift=1em](tagb#2 helper) at (tagb#2.south~west) {};
}
\newcommand{\tagc}[4]{
	\showtag{tag, below~of=tagb#4, node~distance=#3em, xshift=2em}{tagc#2}{#1};
	\draw[tagarrow] (tagb#4 helper) |- (tagc#2);
}

\newcounter{bcounter}
\newcounter{ccounter}
\newcommand{\tagA}[1]{
	\showtag{tag}{A}{#1};
	%\node[tag](A){#1};
	\node[coordinate, xshift=.5em](A helper) at (A.south~west) {};
}
\newcommand{\tagB}[2]{
	\showtag{tag~wide, below~of=A, node~distance=#2em, xshift=3.5em}{B}{#1};
	\draw[tagarrow] (A helper) |- (B);
	\node[coordinate, right~of=B, node~distance=6.1em](B helper){};
}
\newcommand{\tagC}[2]{
	\seq_set_split:Nnn \arg { / } { #1 }
	\seq_pop_left:NN \arg \argl
	\showtag{tag~next~to~wide, right~of=B, yshift=#2em}{C}{\argl};
	\draw[tagarrow] (B) -- (B helper) |- (C);
	\seq_map_inline:Nn \arg {
		\showtag{tag, below~of=C, node~distance=2em, xshift=1em}{D}{##1};
		\node[coordinate, left~of=D, node~distance=\hwidth, yshift=1.2em](D helper){};
		\draw[tagarrow] (D helper) |- (D);
		\stepcounter{ccounter}
		\stepcounter{bcounter}
	}
}
\newcommand{\scentree}[2]{
	\begin{tikzpicture}
	\seq_set_split:Nnn \arg { ; } { #1 }
	\seq_pop_left:NN \arg \argl
	\StrGobbleLeft{\argl}{1}[\tagAtext]
	\tagA{\tagAtext}
	\node[number, left~of=A]{#2.};
	\setcounter{bcounter}{1}
	\seq_map_inline:Nn \arg {
		\setcounter{ccounter}{0}
		
		\seq_set_split:Nnn \subarg { , } { ##1 }
		\seq_pop_left:NN \subarg \subargl
		\tagB{\subargl}{2*\arabic{bcounter}}
		
		\seq_map_inline:Nn \subarg {
			\tagC{ ####1 }{-2*\arabic{ccounter}}
			\stepcounter{ccounter}
			\stepcounter{bcounter}
		}
	}
	\end{tikzpicture}
}
\newcommand{\scenrow}[2]{
	\StrLeft{#1}{1}[\firstchar]
	\IfStrEq{\firstchar}{>}{\scentree{#1}{#2}}{\rowtags{#1}{#2}}%
}

\newcommand\topalign[1]{%
	\setbox0\hbox{#1}%
	\raisebox{\dimexpr-\ht0+\dp0\relax}{\usebox0}}
\newcounter{rowtagcounter}
\newcounter{rowtagcounterexternal}
\NewDocumentCommand{\scentags}{O{1} m}{%
	\begin{tabular}[t]{@{}l} 
		\setcounter{rowtagcounter}{#1}
		\seq_set_split:Nnn \arg { | } { #2 }		
		\seq_map_inline:Nn \arg {
			% The vspace is needed to get the alignment right
			\scenrow{##1}{\arabic{rowtagcounter}} \\ \stepcounter{rowtagcounter}
		}
	\end{tabular}
}
\ExplSyntaxOff
