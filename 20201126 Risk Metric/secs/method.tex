\section{Method}
\label{sec:method}

The goal of the proposed method is to quantify the risk of a particular situation in which a vehicle - hereafter, the \textit{ego vehicle} - is in.
Our method for calculating this safety metric for quantifying the risk consists of four steps. 
First, we parameterize the current situation and the possible future situation.
Second, based on the current situation, we estimate the probability (density) for the possible future situations. 
The third step is to determine the probability of a collision based on the current and the future situations.
The final step is to use local regression to speed up the calculations and to make it possible to use the safety metric in real time. 
These four steps are described in the following sections.

In the remainder of this article, the following notation is used. 
To denote a probability, $\probability{\cdot}$ is used. 
\Iac{pdf} is denoted by $\density{\cdot}$. 
The conditional probability $\probabilitycond{\dummyvara}{\dummyvarb}$ is verbalized as \textit{the probability of $\dummyvara$ given $\dummyvarb$}. 
Similarly, the conditional \ac{pdf} is denoted by $\densitycond{\cdot}{\cdot}$. 
To denote the estimation of any of the aforementioned quantities, a circumflex is used. 
E.g, $\probabilityest{\dummyvara}$ denotes the estimated probability of $\dummyvara$.



\subsection{Parameterize current and future situations}
\label{sec:parametrization}

The first step is to parameterize the current situation in which the ego vehicle is in. 
In other words, the current situation needs to be described using $\situationcurrentdim$ numbers that are stacked into one vector $\situationcurrent \in \situationcurrentspace \subseteq \realnumbers^{\situationcurrentdim}$. 
As an example, $\situationcurrent$ could contain the speed of the ego vehicle and distance towards its preceding vehicle. 
In \cref{sec:case study}, we will see more examples.

Next to describing the current situation, the future situation is described using $\situationfuturedim$ numbers stacked into one vector $\situationfuture \in \situationfuturespace \subseteq \realnumbers^{\situationfuturedim}$. 
Together with $\situationcurrent$, $\situationfuture$ contains enough information to describe how the relevant future around the ego vehicle develops over time. 
As an example, $\situationfuture$ could contain the acceleration of the lead vehicle (if any) that is in front of the ego vehicle.

Let $\collision$ denote a collision, such that the probability of a collision is $\probability{\collision}$.
The goal of our safety metric is to estimate the probability of a collision given a particular situation $\situationcurrent$, i.e., $\probabilitycond{\collision}{\situationcurrent}$.
We do this by considering all future situations, $\situationfuturespace$, and calculating the probability of a collision given each possible value of $\situationfuture$. 
Using integrating, we obtain $\probabilitycond{\collision}{\situationcurrent}$:
\begin{equation}
	\label{eq:probability collision expectation}
	\probabilitycond{\collision}{\situationcurrent} 
	= \int_{\situationfuturespace} 
	\probabilitycond{\collision}{\situationcurrent, \situationfuture} 
	\densitycond{\situationfuture}{\situationcurrent} 
	\ud \situationfuture.
\end{equation}
In \cref{sec:estimate future}, we propose a method to estimate $\densitycond{\situationfuture}{\situationcurrent}$ and in \cref{sec:estimate collision}, we propose a method to estimate $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$.



\subsection{Estimate $\densitycond{\situationfuture}{\situationcurrent}$}
\label{sec:estimate future}

In this section, we propose a method to estimate $\densitycond{\situationfuture}{\situationcurrent}$, i.e., the \ac{pdf} of the $\situationfuture$ given $\situationcurrent$.
Using the product rule for probability, we can write:
\begin{equation}
	\densitycond{\situationfuture}{\situationcurrent} 
	= \frac{\density{\situationcurrent, \situationfuture}}{\density{\situationcurrent}}
	= \frac{\density{\situationcurrent, \situationfuture}}{
		\int_{\situationfuturespace} \density{\situationcurrent, \situationfuture} \ud\situationfuture
	}
\end{equation}
Thus, it suffices to estimate $\density{\situationcurrent, \situationfuture}$. 

Our proposal is to estimate $\density{\situationcurrent, \situationfuture}$ in a data-driven manner. 
A data-driven approach brings several benefits.
First, the estimate automatically adapts to local driving styles and behaviors, which can change from region to region, provided that the data are obtained from the same local traffic.
Second, strong assumptions such as assuming a constant speed of other vehicles, are not needed.
For our data-driven approach, let us assume that we have obtained $\situationnumberof$ situations, denoted by $\situationcurrentinstance_{\situationindex}\in\situationcurrentspace, \situationindex\in\{1,\ldots,\situationnumberof\}$, and their corresponding future situations described by $\situationfutureinstance_{\situationindex}\in\situationfuturespace$.



\subsubsection{Special case: all parameters from one distribution}
\label{sec:one kde}

We first explain how to estimate $\density{\situationcurrent, \situationfuture}$ if we assume that all parameters depend on each other and that no further simplifications are possible. 
The shape of the \ac{pdf} $\density{\situationcurrent, \situationfuture}$ is unknown beforehand. 
Furthermore, the shape of the estimated \ac{pdf} might change as more data are acquired. 
Assuming a functional form of the \ac{pdf} and fitting the parameters of the \ac{pdf} to the data may therefore lead to inaccurate fits unless a lot of hand-tuning is applied.
We employ a non-parametric approach using \ac{kde} \autocite{rosenblatt1956remarks, parzen1962estimation} because the shape of the \ac{pdf} is automatically computed and \ac{kde} is highly flexible regarding the shape of the \ac{pdf}. 
Using the \ac{kde}, the estimated \ac{pdf} becomes:
\begin{equation}
	\label{eq:kde estimate}
	\densityest{\situationcurrent,\situationfuture}
	= \frac{1}{\situationnumberof} \sum_{\situationindex=1}^{\situationnumberof}
	\kernelfuncnormalized{\bandwidthmatrix}{
		\begin{bmatrix}
			\situationcurrent \\
			\situationfuture
		\end{bmatrix} -
		\begin{bmatrix}
			\situationcurrentinstance_{\situationindex} \\
			\situationfutureinstance_{\situationindex}
		\end{bmatrix}
	},
\end{equation}
where $\kernelfuncnormalized{\bandwidthmatrix}{\cdot}$ is an appropriate kernel function with positive definite bandwidth matrix $\bandwidthmatrix$. 
The choice of the kernel $\kernelfuncnormalized{\bandwidthmatrix}{\cdot}$ is not as important as the choice of the bandwidth matrix $\bandwidthmatrix$ \cite{turlach1993bandwidthselection}.
We use a Gaussian kernel, but our method also applies with other kernels.
The Gaussian kernel is given by
\begin{equation}
	\label{eq:kernel current future}
	\kernelfuncnormalized{\bandwidthmatrix}{\dummyvarkernel}
	= \frac{1}{\left( 2 \pi \right)^{\left( \situationcurrentdim + \situationfuturedim \right) / 2} 
	\left|\bandwidthmatrix\right|^{1/2} }
	\e{ -\frac{1}{2} \dummyvarkernel^T \bandwidthmatrix^{-1} \dummyvarkernel }.
\end{equation}

The bandwidth matrix controls the width of the Gaussian kernel, or, in other words, the influence of each sampling point on nearby regions. 
There are many different ways of estimating the bandwidth, ranging from simple reference rules like, e.g., Silverman's rule of thumb \autocite{silverman1986density} to more elaborate methods; see \autocite{turlach1993bandwidthselection, chiu1996comparative, jones1996brief, bashtannyk2001bandwidth, zambom2013review} for reviews of different bandwidth selection methods.
Here, we use one-leave-out cross-validation to compute the bandwidth becayse this minimizes the Kullback-Leibler divergences between the real \ac{pdf} $\density{\situationcurrent, \situationfuture}$ and the estimated \ac{pdf} $\densityest{\situationcurrent, \situationfuture}$ \autocite{turlach1993bandwidthselection, zambom2013review}.

Drawing samples from the \ac{kde} in \cref{eq:kde estimate} is straightforward: two random numbers are drawn, one to choose a random generator Gaussian out of the $\situationnumberof$ Gaussians that are used to construct the \ac{kde}, and one random number from that Gaussian.
Sampling from $\densityestcond{\situationfuture}{\situationcurrent}$ works similarly, but instead of using an equal probability for each random generator Gaussian to be selected, different probabilities are used based on $\situationcurrent$.
For more information on sampling from a conditional \ac{pdf} obtained using \ac{kde}, see \autocite{holmes2012fast}.



\subsubsection{Not all parameters from one distribution}
\label{sec:no special case}

Estimating $\density{\situationcurrent, \situationfuture}$ with one \ac{kde} according to \cref{eq:kde estimate} becomes problematic if $\situationcurrentdim + \situationfuturedim$ becomes large, due to the curse of dimensionality \cite{scott2015multivariate}.
There are a few ways to avoid problems.
Without going into much detail, we will list a few options.

One option is to assume that one or more parameter are independent of the other parameters. 
E.g., suppose that $\situationfuture=\begin{bmatrix}\situationfutureparta & \situationfuturepartb\end{bmatrix}^T$, such that $\situationfuturepartb$ is independent of $\situationcurrent$ and $\situationfutureparta$.
Then we can write
\begin{equation}
	\density{\situationcurrent, \situationfuture}
	= \density{\situationcurrent, \situationfutureparta, \situationfuturepartb}
	= \density{\situationcurrent, \situationfutureparta} \cdot \density{\situationfuturepartb}.
\end{equation}
In this case, we would need to estimation $\density{\situationcurrent, \situationfutureparta}$ and $\density{\situationfuturepartb}$, which can be done in a similar manner as presented in \cref{sec:one kde}.
Because these two \acp{pdf} have less variables than $\density{\situationcurrent, \situationfuture}$, it will suffer less from the curse of dimensionality \cite{scott2015multivariate}.

Another option is to model $\densitycond{\situationfuture}{\situationcurrent}$ as a cascade of conditional probabilities. E.g., using the partitioning $\situationfuture=\begin{bmatrix}\situationfutureparta & \situationfuturepartb\end{bmatrix}^T$, $\densitycond{\situationcurrent}{\situationfuture}$ can be approximated using two conditional densities:
\begin{equation}
	\densitycond{\situationcurrent}{\situationfutureparta}
	= \densitycond{\situationfutureparta, \situationfuturepartb}{\situationcurrent}
	= \densitycond{\situationfutureparta}{\situationfuturepartb, \situationcurrent} \cdot \densitycond{\situationfuturepartb}{\situationcurrent}
	\approx \densitycond{\situationfutureparta}{\situationfuturepartb} \cdot \densitycond{\situationfuturepartb}{\situationcurrent}.
\end{equation}
The same partitioning can be applied to $\densitycond{\situationfutureparta}{\situationfuturepartb}$ and $\densitycond{\situationfuturepartb}{\situationcurrent}$ until only two-dimensional \acp{pdf} need to be estimated.
For more information on this, we refer the reader to \autocite{aas2009paircopula, nagler2016evading}.



\subsection{Estimate $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$}
\label{sec:estimate collision}

To estimate $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$, i.e., the probability of a collision given the current situation $\situationcurrent$ and the future situation $\situationfuture$, we employ simulations. 
The details of the simulation depends on the actual application. 
For example, if the goal of our surrogate safety metric is to evaluate the risk a current human driver is in, the simulation should involve human driver models. 
On the other hand, if the goal is to evaluate the risk of \iac{ads}, the simulation should include the same \iac{ads}.

If the result of a simulation only depends on $\situationcurrent$ and $\situationfuture$, i.e., the simulation is fully deterministic and stochastic influences like sensor noise are not considered, then $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$ is either $0$ or $1$.
In this case, one simulation suffices to determine $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$.
If, on the other hand, there are other factors then $\situationcurrent$ and $\situationfuture$ that influence the result, more simulations are needed.
A straightforward way to compute $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$ is to repeat a certain number of simulations with the same $\situationcurrent$ and $\situationfuture$ and count the number of simulations that result in a collision.
If $\numberofsimulations$ denotes the number of simulations and $\numberofcollisions$ is the number of collisions, then $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$ could be estimated using
\begin{equation}
	\label{eq:binomial estimation}
	\probabilityestcond{\collision}{\situationcurrent, \situationfuture}
	= \frac{\numberofcollisions}{\numberofsimulations}.
\end{equation}

An important choice for estimating $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$ is the number of simulations, $\numberofsimulations$.
One approach is to keep increasing $\numberofsimulations$ until there is enough confidence in the estimation of \cref{eq:binomial estimation}.
E.g., the Clopper-Pearson interval \autocite{clopper1934use} or the Wilson score interval \autocite{wilson1927probable} can be used to determine the confidence of the estimation of \cref{eq:binomial estimation}.
A disadvantage of this approach is that only the fact that a simulation results in a collision is used while the simulation provides more information. 
Therefore, we provide an alternative approach to estimate $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$.

Let $\simulationresult \in \realnumbers^{\dimsimulationresult}$ be a vector representing the result of a simulation, such that $\simulationresult \in \spacecollision$ if and only if the simulation results in a collision.
Here, $\spacecollision \subset \realnumbers^{\dimsimulationresult}$ represents the set of possible simulation results in which a collision occurs. 
Therefore, we have
\begin{equation}
	\probabilitycond{\collision}{\situationcurrent, \situationfuture}
	= \probabilitycond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}
	= \int_{\spacecollision} \densitycond{\simulationresult}{\situationcurrent, \situationfuture} \ud \simulationresult.
\end{equation}
Similar as with the estimation of $\density{\situationcurrent, \situationfuture}$ in \cref{sec:estimate future}, we employ \ac{kde} to estimate $\densitycond{\simulationresult}{\situationcurrent, \situationfuture}$:
\begin{equation}
	\label{eq:kde simulation result}
	\densityestcond{\simulationresult}{\situationcurrent, \situationfuture}
	= \frac{1}{\numberofsimulations} 
	\sum_{\simulationindex=1}^{\numberofsimulations} \kernelfuncnormalized{\simulationbandwidth}{\simulationinstance{\simulationindex} - \simulationresult},
\end{equation}
where $\simulationinstance{\simulationindex}$ denotes the result of the $\simulationindex$-th simulation and $\simulationbandwidth$ denotes an appropriate bandwidth matrix.
The kernel function $\kernelfuncnormalized{\simulationbandwidth}{\cdot}$ is similarly defined as \cref{eq:kernel current future}.
We can now estimate $\probabilitycond{\collision}{\situationcurrent, \situationfuture}$ by substituting $\densityestcond{\simulationresult}{\situationcurrent, \situationfuture}$ of \cref{eq:kde simulation result} for $\densitycond{\simulationresult}{\situationcurrent, \situationfuture}$:
\begin{equation}
	\label{eq:estimate probability of collision}
	\probabilityestcond{\collision}{\situationcurrent, \situationfuture}
	= \probabilityestcond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}
	= \int_{\spacecollision} \densityestcond{\simulationresult}{\situationcurrent, \situationfuture} \ud \simulationresult.
\end{equation}

We are still left with choosing the number of simulations $\numberofsimulations$ in \cref{eq:kde simulation result}.
Our proposal is keep increasing $\numberofsimulations$ until the variance of $\probabilityestcond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}$ is below a threshold $\simulationthreshold$.
The variance follows from \textcite{nadaraya1964some}:
\begin{equation}
	\variance{\probabilityestcond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}}
	= \frac{\probabilitycond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}
		\left( 1-\probabilitycond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture} \right)}{\numberofsimulations}.
\end{equation}
Because $\probabilitycond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}$ is unknown, we use the estimated counterpart of \cref{eq:estimate probability of collision}.
Thus, $\numberofsimulations$ is increased until the following condition is met:
\begin{equation}
	\label{eq:condition stop simulations}
	\frac{\probabilityestcond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture}
		\left( 1-\probabilityestcond{\simulationresult \in \spacecollision}{\situationcurrent, \situationfuture} \right)}{\numberofsimulations}
	< \simulationthreshold.
\end{equation}



\subsection{Estimate $\probabilitycond{\collision}{\situationcurrent}$}

To estimate $\probabilitycond{\collision}{\situationcurrent}$, we use a Monte Carlo simulation to approximate the integral in \cref{eq:probability collision expectation}:
\begin{equation}
	\label{eq:monte carlo collision}
	\probabilityestcond{\collision}{\situationcurrent}
	= \frac{1}{\numberofmontecarlo} \sum_{\simulationindex=1}^{\numberofmontecarlo}
	\probabilityestcond{\collision}{\situationcurrent, \situationfutureinstance_{\situationindex}}
	\quad \situationfutureinstance_{\situationindex} \sim \densityestcond{\situationfuture}{\situationcurrent}
\end{equation}
The future situations $\situationfutureinstance_{\situationindex}$ that are generated by drawing from the distribution $\densityestcond{\situationfuture}{\situationcurrent}$ follow the probability density of the situations that are captured in the data.
Therefore, the more often a situation is recorded, the more likely it is that the sample $\situationfutureinstance_{\situationindex}$ resembles it.
This is what we want, because situations that are more likely to occur will contribute more to the estimation of $\probabilitycond{\collision}{\situationcurrent}$.
This may, however, not be the most efficient way to estimate $\probabilitycond{\collision}{\situationcurrent}$, because collisions are most likely happening for rare situations where $\densityestcond{\situationfuture}{\situationcurrent}$ is low.
As a result, the relative variance of $\probabilitycond{\collision}{\situationcurrent}$ will be large. 
To reduce the relative variance, the so-called technique of importance sampling could be applied.
With importance sampling, the samples $\situationfutureinstance_{\situationindex}$ are drawn from another distribution that puts more weight on the situations that are more likely to result in collision. 
To get an unbiased result, the estimated probability $\densityestcond{\situationfuture}{\situationcurrent}$ in \cref{eq:monte carlo collision} is then weighted. 
Importance sampling is out of scope of this article.
For more information, we refer the interested reader to \autocite{deGelder2017assessment, zhao2018evaluation}, in which the authors successfully applied importance sampling to assess \acp{ads}.

Since we want to evaluate the risk metric during real-time operation of the ego vehicle, the expression of \cref{eq:monte carlo collision} is problematic, even if the calculation is accelerated using a technique like importance sampling.
Therefore, we propose to evaluate \cref{eq:monte carlo collision} only for some fixed $\situationcurrentinstance_{\situationindexdesign}, \situationindexdesign\in\{1,\ldots,\numberofdesignpoints\}$.
Next, local regression is used to estimate \cref{eq:monte carlo collision}.
More specifically, we use the \ac{nw} kernel estimator \autocite{wasserman2006nonparametric}:
\begin{equation}
	\probabilityestcond{\collision}{\situationcurrent}
	\approx \frac{ \sum_{\situationindex=1}^{\numberofdesignpoints}
		\kernelfuncnormalized{\bandwidthnw}{\situationcurrent - \situationcurrentinstance_{\situationindexdesign}}
		\probabilityestcond{\collision}{\situationcurrentinstance_{\situationindexdesign}}
	}{\sum_{\situationindex=1}^{\numberofdesignpoints}
		\kernelfuncnormalized{\bandwidthnw}{\situationcurrent - \situationcurrentinstance_{\situationindexdesign}}}.
\end{equation}
Here, $\probabilityestcond{\collision}{\situationcurrentinstance_{\situationindex}}$ is based \cref{eq:monte carlo collision} and $\kernelfuncnormalized{\bandwidthnw}{\cdot}$ represents the Gaussian kernel given by \cref{eq:kernel current future}.
Two important choices have to be made: The choice of the $\situationcurrentinstance_{\situationindexdesign}, \situationindexdesign\in\{1,\ldots,\numberofdesignpoints\}$ for which to evaluate \cref{eq:monte carlo collision} and the choice of the bandwidth matrix $\bandwidthnw$.
We suggest to base the design points $\situationcurrentinstance_{\situationindexdesign}, \situationindexdesign\in\{1,\ldots,\numberofdesignpoints\}$ on the data that is used to estimate $\densitycond{\situationfuture}{\situationcurrent}$ in \cref{sec:estimate future}, i.e., $\situationcurrentinstance_{\situationindex}, \situationindex \in \{1,\ldots,\situationnumberof\}$, such that all $\situationcurrentinstance_{\situationindex}$ have at least one design point $\situationcurrentinstance_{\situationindexdesign}$ within a distance of $\distancedesignpoints$:
\begin{equation}
	\min_{\situationindexdesign} \normtwo{ \situationcurrentinstance_{\situationindex} - \situationcurrentinstance_{\situationindexdesign} } \leq \distancedesignpoints,
	\quad \forall \situationindex \in \{1, \ldots, \situationnumberof\}.
\end{equation}
We compute the bandwidth matrix $\bandwidthnw$ using one-leave-out cross-validation.

