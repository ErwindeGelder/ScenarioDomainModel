\section{Method for risk quantification}
\label{sec:method}

Our method for quantifying the risk for \iac{ads} consists of 5 steps:
\begin{itemize}
	\item Identify the scenarios that are part of the so-called \ac{odd} of the \ac{ads}.
	\item Determine the exposure of these scenarios, i.e., the expected number of occurrences.
	\item Simulate the response of the \ac{ads} in these scenarios.
	\item Calculate the expected number of harmful events.
	\item Calculate the severity, i.e., the expected injury rate.
\end{itemize}
These steps are schematically shown in \cref{fig:method}. 
In \cref{tab:definitions}, we present the definitions of the terms that are used in our proposed method.
In the following subsections, these 5 steps are further described.

\begin{figure*}
	\centering
	\input{figures/method.tikz}
	\caption{Schematic overview of the risk quantification method presented in this article. 
		Each of the 5 steps is further explained in \cref{sec:scenario identification,sec:exposure,sec:simulation,sec:harmful,sec:severity}, respectively.}
	\label{fig:method}
\end{figure*}

\newcolumntype{T}{>{\hsize=0.3\hsize}X}
\newcolumntype{D}{>{\hsize=1.7\hsize}X}
\begin{table}
	\caption{The terms and definitions.}
	\label{tab:definitions}
	\begin{tabularx}{\linewidth}{TD}
		\toprule
		Term & Definitions \\ \otoprule
		Risk & Combination of the probability of occurrence of harm and the severity of that harm \autocite{ISO26262} \\
		ODD & Operating conditions under which a given driving automation system or feature thereof is specifically designed to function, including, but not limited to, environmental, geographical, and time-of-day restrictions, and/or the requisite presence or absence of certain traffic or roadway characteristics \autocite{sae2021j3016} \\
		Scenario & Quantitative description of the relevant characteristics and activities and/or goals of the ego vehicle(s), the static environment, the dynamic environment, and all events that are relevant to the ego vehicle(s) within the time interval between the first and the last relevant event \autocite{degelder2021ontology} \\
		Scenario category & Qualitative description of the relevant characteristics and activities and/or goals of the ego vehicle(s), the static environment, and the dynamic environment \autocite{degelder2021ontology} \\
		Triggering condition & Specific conditions of a scenario that [may] serve as an initiator for a subsequent system reaction leading to hazardous behavior \autocite{ISO21448} \\
		\bottomrule
	\end{tabularx}
\end{table}



\subsection{Identification of scenarios}
\label{sec:scenario identification}

% ODD needed
An \ac{ads} is designed to operate within its \ac{odd}.
Therefore, the \ac{odd} is used to limit the risk analysis \autocite{gyllenhammar2020towards}.
So to quantify the risk of \iac{ads} in driving scenarios, we need to know the \ac{odd} of the \ac{ads}.
Once deployed, the \ac{ads} needs to deal with many scenarios and the \ac{odd} in which the \ac{ads} is operating determines the variety of these scenarios.
It is our goal to provide a method for determining the risk for the \ac{ads} in these scenarios.

% Distinguish between scenarios and scenario categories
Considering the wide variety of scenarios, we propose to distinguish between quantitative scenarios and qualitative scenarios, where scenario categories refer to the latter.
It is assumed that all possible scenarios within a given \ac{odd} can be categorized into one or more scenario categories. 
This assumption does not limit the applicability of this article, though it might require many scenario categories to describe all these scenarios.
In the remainder of this section, we will propose a method to calculate the risk for \iac{ads} in all scenarios that are categorized by the same scenario category, i.e., for all $\scenario \in \scenariocategory$ \autocite{degelder2021ontology}, where $\scenario$ and $\scenariocategory$ denote a scenario and a scenario category, respectively.
For example, the scenario category ``cut-in'' comprises all possible cut-in scenarios in the \ac{odd} of the \ac{ads}.
See \autocite{degelder2019scenariocategories} for more examples of scenario categories.

% How to obtain the scenario categories
%The selection of the scenario categories can be either knowledge based or data driven \autocite{riedmaier2020survey}.

% Triggering condition
\begin{remark}
	As part of the scenarios, some factors may cause hazardous behavior. 
	These factors are called ``triggering conditions'', because they may trigger some specific behavior \autocite{ISO21448}.
	Typically, triggering conditions may happen rarely, so we may not know the impact on safety. 
	In our case, one or more triggering conditions could be part of a scenario category.
	Examples of triggering conditions are heavy rain, low road friction, poor lighting, or dirty sensor(s). 
	For more examples, see \autocite{ISO21448}.
\end{remark}



\subsection{Probability of exposure}
\label{sec:exposure}

To determine the exposure, we estimate the expected number of encounters of a scenario $\scenario\in\scenariocategory$.
Let $\numberofencounters$ denote the number of encounters.
We express the exposure as $\expectation{\numberofencounters|\scenario\in\scenariocategory}$, i.e., the expected number of encounters of a scenario $\scenario$ from the scenario category $\scenariocategory$.
The exposure could be either expressed in terms of number of encounters per unit of distance or number of encounters per unit of time.
To calculate the exposure, we use the following equation:
\begin{equation}
	\label{eq:exposure}
	\expectation{\numberofencounters|\scenario\in\scenariocategory}
	 = \sum_{\numberofencounters=1}^{\infty} \numberofencounters \probability{\numberofencounters|\scenario\in\scenariocategory},
\end{equation}
where $\probability{\numberofencounters|\scenario\in\scenariocategory}$ denotes the probability of encountering $\numberofencounters$ scenarios $\scenario\in\scenariocategory$.

We propose to determine $\probability{\numberofencounters|\scenario\in\scenariocategory}$, $\numberofencounters=1,2,\ldots$, based on data, because the data provide an objective and quantitative way to estimate $\probability{\numberofencounters|\scenario\in\scenariocategory}$, $\numberofencounters=1,2,\ldots$, assuming that the data are collected with the same conditions as specified by the \ac{odd} of the \ac{ads}.
The probability can be estimated by counting the number of occurrences of the scenarios in the data.
The method to find the scenarios $\scenario\in\scenariocategory$ is explained in \autocite{degelder2020scenariomining}.
In short, a two-step approach is used.
First, tags are used to annotate the data.
Tags describe, e.g., the behavior of the ego vehicle and any other vehicle.
Second, by searching for the combination of tags that describes the scenario category $\scenariocategory$, the scenarios are extracted from the data.

\begin{remark}
	It is not uncommon to assume that $\probability{\numberofencounters|\scenario\in\scenariocategory}$ follows the Poisson distribution \autocite{nicholson1993accidents, wachenfeld2017new, gyllenhammar2020towards}, i.e., 
	\begin{equation}
		\label{eq:poisson}
		\probability{\numberofencounters|\scenario\in\scenariocategory} = 
		\frac{\poissonparameter^{\numberofencounters}}{\numberofencounters!} \e{-\poissonparameter}.
	\end{equation}
	Here, $\poissonparameter>0$ is a parameter that determines the rate at which a scenario from $\scenariocategory$ occurs.
	Assuming \cref{eq:poisson}, \cref{eq:exposure} simplifies to $\expectation{\numberofencounters|\scenario\in\scenariocategory}=\poissonparameter$.
	The Poisson distribution is only appropriate if we can assume that the occurrence of a scenario $\scenarioinstance{1}\in\scenariocategory$ does not affect the probability that a second scenario $\scenarioinstance{2}\in\scenariocategory$ occurs, the rate at which a scenario from $\scenariocategory$ occurs is constant, and two scenarios from $\scenariocategory$ cannot occur at exactly the same time.
\end{remark}



\subsection{Simulation of scenarios}
\label{sec:simulation}

The next step of the risk quantification is to simulate how the \ac{ads} behaves in the scenarios $\scenario\in\scenariocategory$. 
Let $\parameters\in\realnumbers^{\dimension}$ denote the $\dimension$-dimensional parameter vector that describes scenario $\scenario$. 
Then we denote the (stochastic) outcome of a simulation of scenario $\scenario$ by $\simulationoutcome{\parameters}$, where $\simulationoutcome{\parameters}=1$ means that the simulation of the scenario with parameters $\parameters$ ended with a collision and otherwise $\simulationoutcome{\parameters}=0$.
To enable the simulation of the scenarios, a simulation framework is set up.
\Cref{fig:simulation scheme} shows the scheme of the simulation framework, which is represented by these five blocks:
\begin{itemize}
	\item World: the relevant information about the environment of the system under test.
	\item Sensors: mapping of the global information to sensor data which can be used by \iac{ads}. 
	\item \acp{ads}: the logic and control laws employed by the \acp{ads} to perform an automated function.
	The \acp{ads} use the information of the sensors to determine the input to the vehicle.
	The \acp{ads} may provide input to the actuators of the vehicles and information to the operators, e.g., a beep in case of a collision warning.
	\item Operators: assuming that the vehicle is not fully autonomous, an operator can also interact with the vehicle.
	The operator might be the actual driver that is behind the steering wheel, but it might also be an remote operator.
	\item Vehicles: the responses of all vehicles based on the input generate by the \acp{ads} and operators.
\end{itemize}

\begin{figure}
	\centering
	\input{figures/simulation_scheme.tikz}
	\caption{Scheme of the simulation framework.}
	\label{fig:simulation scheme}
\end{figure}

Note that the simulation scheme allows for tests with multiple vehicles.
For example, when testing (cooperative) \ac{acc} systems, one might be interesting in the performance of a platoon of vehicles, rather than the performance of a single vehicle.



\subsection{Probability of collision}
\label{sec:harmful}

Whereas the outcome of a single simulation run $\simulationoutcome{\parameters}$ provides insight in the behavior of the \ac{ads} under test in one specific scenario, the actual goal is to calculate the risk for all scenarios from scenario category $\scenariocategory$. 
The first step toward the calculation of the risk is to compute the expected outcome given all scenarios $\scenario\in\scenariocategory$: $\expectation{\simulationoutcome{\parameters}|\scenario\in\scenariocategory}$.

As a source of information for the scenarios for the simulations, the use of real-world driving data is proposed.
In this way, the scenarios are guaranteed to represent real-world driving conditions \autocite{elrofai2018scenario, putz2017pegasus, krajewski2018highD}.
One approach would be to simply simulate the scenarios that are recorded from the data, but this gives two problems.
First, because not all possible variations of the scenarios might be found in the data, the failure modes of the \ac{ads} might not be reflected in the simulations \autocite{zhao2018evaluation}.
Second, because the set of extracted scenarios is largely composed of non-safety critical scenarios, many scenarios may be required to obtain the required statistical accuracy of rare events such as collisions \autocite{zhao2018evaluation, jesenski2020scalable}.
To overcome these problems, so-called \ac{is} has been introduced in order to put more emphasis on scenarios that are likely to trigger safety-critical situations \autocite{zhao2018evaluation, xu2018accelerated, jesenski2020scalable}.

In this section, we propose \iac{is} method without requiring a-priori knowledge of what might be scenarios that are likely to trigger safety-critical situations given the \ac{ads} under test.
First, \iac{cmc} sampling is used, see \cref{sec:cmc}.
In \cref{sec:is}, we propose the \ac{is} method based on the simulation results of the \ac{cmc} sampling.



\subsubsection{Crude Monte Carlo sampling}
\label{sec:cmc}

In \ac{cmc}, parameters are sampled from \iac{pdf}. 
Let $\density{\parameters|\scenario\in\scenariocategory}$ denote the \ac{pdf} of $\parameters$ given that the scenarios are from scenario category $\scenariocategory$.
Typically, the \ac{pdf} $\density{\parameters|\scenario\in\scenariocategory}$ is unknown, so we need to estimate it.
To estimate the \ac{pdf}, we use the observed scenarios that we also used to estimate the exposure (\cref{sec:exposure}).
Because the shape of the \ac{pdf} is also unknown beforehand, assuming a predefined functional form of the \ac{pdf} for which certain parameters are fitted to the data may lead to inaccurate fits unless a lot of hand-tuning is applied. 
As an alternative, we propose to estimate $\density{\parameters|\scenario\in\scenariocategory}$ using \ac{kde} \autocite{rosenblatt1956remarks, parzen1962estimation}.
Let $\parametersinstance{1},\ldots,\parametersinstance{\scenariosnumberof}$ denote the parameters of the observed scenarios $\scenarioinstance{\scenarioindex}\in\scenariocategory$, $\scenarioindex\in\{1,\ldots,\scenariosnumberof\}$, then the density $\density{\parameters|\scenario\in\scenariocategory}$ is estimated by
\begin{equation}
	\kde{\bandwidth}{\parameters|\scenario\in\scenariocategory}
	= \frac{1}{\scenariosnumberof\bandwidth^{\dimension}}\sum_{\scenarioindex=1}^{\scenariosnumberof}
	\kernelfunc{\frac{1}{\bandwidth}\left(\parameters-\parametersinstance{\scenarioindex}\right)}.
\end{equation}
Here, $\kernelfunc{\cdot}$ is the so-called kernel and $\bandwidth$ is the bandwidth.
The choice of the kernel function is not as important as the choice of the bandwidth \autocite{turlach1993bandwidthselection, duong2007ks}.
We use the often-used Gaussian kernel, but our method also applies with other kernels.
The Gaussian kernel is given by
\begin{equation}
	\kernelfunc{\dummyvar} = \frac{1}{\left(2\pi\right)^{\dimension/2}} 
	\e{-\frac{1}{2} \normtwo{\dummyvar}^2},
\end{equation}
where $\normtwo{\dummyvar}^2=\dummyvar\transpose\dummyvar$ denotes the squared 2-norm of $\dummyvar$.

The bandwidth $\bandwidth>0$ is a free parameter that controls the width of the kernel.
A larger bandwidth results in a smoother \ac{pdf}, but choosing $\bandwidth$ too large may result in the loss of details in the \ac{pdf}.
Methods for estimating the bandwidth range from simple reference rules like Silverman's rule of thumb \autocite{silverman1986density} to more elaborate methods (for reviews, see \autocite{turlach1993bandwidthselection, bashtannyk2001bandwidth, jones1996brief}).
We use one-leave-out cross validation to determine the optimal bandwidth, so that the bandwidth equals
\begin{equation}
	\arg \min_{\bandwidth} \prod_{\scenarioindex=1}^{\scenariosnumberof}
	\left( 
		\frac{1}{\scenariosnumberof-1} 
		\sum_{\indexsampling=1,\indexsampling\ne\scenarioindex}^{\scenariosnumberof}
		\kernelfunc{\frac{1}{\bandwidth}\left(
			\parametersinstance{\indexsampling}-\parametersinstance{\scenarioindex}
		\right)}
	\right).
\end{equation}
Note that with the one-dimensional bandwidth $\bandwidth$, the same amount of smoothing is applied in every direction.
Our method can easily be extended to a multi-dimensional bandwidth.

Sampling from $\kde{\bandwidth}{\parameters|\scenario\in\scenariocategory}$ is straightforward.
First, an integer $\indexsampling\in\{1,\ldots,\scenariosnumberof\}$ is randomly chosen.
Next, a random sample is drawn from a Gaussian with covariance $\bandwidth^2\identitymatrix{\dimension}$ and mean $\parametersinstance{\indexsampling}$, where $\identitymatrix{\dimension}$ denotes the $\dimension$-by-$\dimension$ identity matrix.

With \ac{cmc}, the probability of a collision is calculated by taking the mean of $\simulationoutcome{\parameters}$ with a large number of different realizations of $\parameters$:
\begin{equation}
	\expectation{\simulationoutcome{\parameters}|\scenario\in\scenariocategory}
	\approx \frac{1}{\numberofmc} \sum_{\indexsampling=1}^{\numberofmc}
	\simulationoutcome{\parametersinstance{\indexsampling}}, 
	\, \parametersinstance{\indexsampling} \fromdistribution \kde{\bandwidth}{\parameters|\scenario\in\scenariocategory}.
\end{equation}



\subsubsection{Importance sampling}
\label{sec:is}



\subsection{Calculation of severity}
\label{sec:severity}
