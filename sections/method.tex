\section{Proposed Risk Estimation Method}
\label{sec:method}
 
In the Hazard Analysis and Risk Assessment (HARA) required by the ISO~26262 standard, the estimation of Automotive Safety Integrity Level (ASIL) is calculated based on a so-called single specific hazardous event \cite{ISO26262}.
Although the operational situation in which this single event occurs as well as the operating mode are considered in the analysis, still the proceeding and successive events are not taken into account.
In this paper, we propose a new method to estimate the risk of a certain scenario considering the whole chain of activities and conditions that constitute the scenario.
The estimated risk is based on real-world driving data. To estimate the risk, we will quantify the exposure and the severity.

As explained in \cref{sec:definitions}, a scenario consist of a set of conditions and activities, denoted by $A$ and $C$, respectively. We formulate the exposure as the average number of occurrences of the activities $A$ under the conditions $C$, denoted by $\lambda_{A,C}$. The severity is the likelihood of the potential hazardous consequence $R$ given the activities $A$ and the conditions $C$, denoted by the conditional probability $P(R|A,C)$. The risk is computed as the multiplication of the exposure and the severity. 

The proposed method is summarized in \cref{fig:method}. To compute the exposure, we calculate the likelihood of the conditions, denoted by $P(C)$, and the conditional likelihood of the activities, denoted by $P(A|C)$, based on real-world driving data. This is explained in detail in \cref{sec:exposure}. For the estimation of the severity, we consider all possible scenarios that are subject to a set of conditions $C$ and consist of the activities $A$. Therefore, we parametrize the scenarios using the parameter vector $\theta$. Based on the real-world driving data, the probability density function of the parameters $P(\theta|A,C)$ is estimated. Next, using simulations, we estimate $P(R|\theta,A,C)$, the likelihood of a potential hazardous consequence $R$ given a parametrized scenario. The details of the estimation of the severity are presented in \cref{sec:severity}. Finally, in \cref{sec:risk}, we describe how the risk is estimated based on the estimated exposure and severity.

\begin{figure}
	\centering
	\includestandalone[width=\linewidth]{figures/method}
	\caption{Proposed method for quantifying the risk. The risk is a multiplication of the exposure and the severity, explained in \cref{sec:exposure,sec:severity}, respectively.}
	\label{fig:method}
\end{figure}

%The following steps are followed when computing the risk:
%\begin{enumerate}
%	\item Estimate the likelihood of the conditions $P(C)$.
%	\item Estimate the exposure $\lambda_{A,C}$.
%	\item Parametrize the scenario with a parameter vector $\theta$.
%	\item Estimate the distribution of $\theta$ for this scenario class, i.e., $P(\theta|A,C)$.
%	\item Use simulations to estimate the severity, i.e., $P(R|A,C)$.
%	\item Compute the risk of a scenario class denoted by $\lambda$.
%	\item Compute the number of hours that can be driven without any harm associated with the given scenario class.
%\end{enumerate}


\subsection{Calculate exposure}
\label{sec:exposure}

The scenarios are subject to $n_C$ conditions, denoted by $C_1, \ldots, C_m$. For the sake of brevity, all conditions together are denoted by $C$, i.e., $P(C_1, \ldots, C_{n_C})=P(C)$. Many of these conditions might be based on the operational design domain\footnote{``Operating conditions under which a given driving automation system or feature thereof is specifically designed to function'' \cite{sea2018j3016}.} of the automation system and might include conditions with respect to the infrastructure, weather conditions, lighting conditions, and geographical locations. 

The first step is to compute the joint probability of the conditions, i.e., $P(C)$. In case these conditions are independent, the probability can be computed by simply multiplying the individual likelihoods for each condition, i.e., $P(C)=P(C_1)\cdot\ldots\cdot P(C_{n_C})$. This, however, might not necessarily be the case, which requires either to compute the joint probability or to compute conditional probabilities. In some cases, it might also be reasonable to simply assume that the likelihood of certain conditions are independent.

Note that the the defined conditions might not be the same as the conditions under which the data is collected that is used to compute $P(C)$. This might require additional assumptions, see our example in \cref{sec:example conditions}.

To calculate the exposure, the average number of occurrences of the activities that constitute the scenarios that fall into the specified scenario class within a certain time interval need to be estimated. Let $n_A$ denote the number of activities, such that $A_1, \ldots, A_{n_A}$ denote the activities. For the sake of brevity, all activities together are denoted by $A$. 

Without loss of generality, we assume that the time interval is an hour. To estimate the number occurrences of the activities, the data for which the conditions $C$ are satisfied are analyzed. The average number of occurrences of the activities $A$ for each hour of driving for which the conditions $C$ are satisfied is denoted by $\lambda_{A|C}$. Next, we can calculate the average number of occurrences of the activities $A$ under the conditions $C$ for each hour of driving:
\begin{equation}
	\lambda_{A,C} = \lambda_{A|C} \cdot P(C).
\end{equation}

Regarding the scenarios that fall into the specified scenario class, we assume the following:
\begin{itemize}
	\item The occurrence of one scenario consisting of activities $A$ and conditions $C$ does not affect the probability that a second scenario consisting of activities $A$ and conditions $C$ occurs.
	\item The rate at which a scenario consisting of activities $A$ and conditions $C$ occurs is constant. I.e., $\lambda_{A,C}$ is constant.
	\item Two scenarios consisting of activities $A$ and conditions $C$ cannot occur at exactly the same time instant.
\end{itemize}
Based on these assumptions, the number of occurrences of scenarios consisting of activities $A$ and conditions $C$ is distributed according to the Poisson distribution:
\begin{equation}
	P(k\text{ times }A,C\text{ in an hour}) = \exp \left\{-\lambda_{A,C} \right\} \frac{\lambda_{A,C}^k}{k!}.
\end{equation}



\subsection{Parametrization}
\label{sec:parametrization}

The third step is to parametrize the scenarios with a parameter vector $\theta \in \mathbb{R}^d$. The parametrization enables the generation of infinitely many unique individual test cases that resemble the scenarios found in naturalistic driving \cite{deGelder2017assessment,elrofai2018scenario}.

In case the parameters are dependent, which is often the case, it is important that the number of parameters is limited to avoid the curse of dimensionality \cite{scott2015multivariate}. This often requires some assumptions. An example is presented in \cref{sec:example parametrization}.



\subsection{Estimation of the pdf}
\label{sec:pdf}

To estimate the probability density function (pdf) of the parameter vector $\theta$, i.e., $P(\theta|A,C)$, either parametric models, non-parametric models, or a combination of the two can be used. In case of parametric models, a certain functional form of the pdf is assumed. For example, it might be assumed that the pdf can be modeled using a Gaussian distribution. In this paper, we present a non-parametric approach using Kernel Density Estimation (KDE) \cite{rosenblatt1956remarks, parzen1962estimation}. Using KDE, there is no assumption on the functional form of the pdf because the shape of the pdf is automatically computed.

Using KDE, the estimated pdf is given by
\begin{equation}
	\label{eq:kde}
	P(\theta|A,C) = \frac{1}{nh^d} \sum_{i=1}^n K\left(\frac{\theta - \theta_i}{h}\right).
\end{equation}
Here, $K(\cdot)$ is an appropriate kernel function and $h$ denotes the bandwidth. From the data, $n$ scenarios are extracted and each scenario is parametrized with $\theta_i$. The choice of the kernel $K(\cdot)$ is not as important as the choice of the bandwidth $h$ \cite{turlach1993bandwidthselection}. Often, a Gaussian kernel is used, which is given by
\begin{equation}
	\label{eq:gaussian kernel}
	K(u) = \frac{1}{\left( 2\pi \right)^{d/2}} \exp \left\{ -\frac{1}{2} \|u\|^2 \right\},
\end{equation}
where $\|u\|^2$ denotes the squared 2-norm of $u$, i.e., $u^T u$.

The bandwidth $h$ controls the amount of smoothing. For the kernel of \cref{eq:gaussian kernel}, the same amount of smoothing is applied in every direction, although this can easily be extended to a multi-dimensional bandwidth, see, e.g., \cite{scott2005multidimensional, chen2017tutorial}. There are many different ways of estimating the bandwidth, ranging from simple reference rules like, e.g., Scott's rule of thumb \cite{scott2015multivariate} or Silverman's rule of thumb \cite{silverman1986density} to more elaborate methods; see \cite{turlach1993bandwidthselection, bashtannyk2001bandwidth, jones1996brief, chiu1996comparative} for reviews of different bandwidth selection methods. 



\subsection{Calculating severity}
\label{sec:simulations}

Let $R$ denote a harmful outcome of a scenario. We define the severity of a scenario with activities $A$ and conditions $C$ as the probability of $R$, given the activities $A$ and $C$, i.e., $P(R|A,C)$. We cannot evaluate $P(R|A,C)$ directly, because the outcome of a scenario highly depends on the parametrization $\theta$. Hence, $P(R|\theta,A,C)$ can be evaluated, for example, through a simulation of the scenario with parameters $\theta$. Using $P(\theta|A,C)$ from \cref{eq:kde}, we can compute 
\begin{equation} \label{eq:probability R theta}
	P(R,\theta|A,C) = P(R|\theta,A,C) \cdot P(\theta|A,C).
\end{equation}
To obtain $P(R|A,C)$, we need to integrate \cref{eq:probability R theta} over $\theta$, i.e., 
\begin{equation} \label{eq:probability R}
	P(R|A,C) = \int_{\mathbb{R}^d} P(R|\theta,A,C) \cdot P(\theta|A,C) \ud \theta.
\end{equation}

One approach to evaluate the integral of \cref{eq:probability R} is to perform Monte Carlo simulations. For sufficiently large $N$, we have
\begin{equation} \label{eq:monte carlo}
	P(R|A,C) \approx \frac{1}{N} \sum_{k=1}^N P(R|\theta_k,A,C), \, \theta_k \sim P(\theta|A,C).
\end{equation}

To improve the accuracy of \cref{eq:monte carlo}, importance sampling can be used where the parameters $\theta$ are drawn from another distribution with a focus on the critical scenarios, see, e.g., \cite{deGelder2017assessment}.



\subsection{Calculating the risk}
\label{sec:risk}

Analogous to the exposure, we define the risk as the number of occurrences of the harmful outcome $R$ in a scenario consisting of activities $A$ and conditions $C$ in a certain time interval. Let $\lambda$ denote the average number of these occurrences in an hour of driving. The chain rule of probability tells us that this equals the sum of $\lambda_{A,C}$ (i.e., the exposure) and $P(R|A,C)$ (i.e., the severity):
\begin{equation} \label{eq:risk}
	\lambda = \lambda_{A,C} \cdot P(R|A,C)
\end{equation}

Analogous to the number of occurrences of a scenario consisting of activities $A$ and conditions $C$, we assume that the number of occurrences of a harmful outcome $R$ in a scenario consisting of activities $A$ and conditions $C$ can be modeled using a Poisson distribution:
\begin{equation} \label{eq:poisson risk}
	P(k\text{ times }R,A,C\text{ in an hour}) = \exp \left\{ -\lambda \right\} \frac{\lambda^k}{k!}.
\end{equation}


\subsection{Likelihood of no harm}
\label{sec:no harm}

Using \cref{eq:poisson risk}, to calculate the probability of not having the harmful outcome $R$ in a scenario consisting of activities $A$ and conditions $C$ we simply need to use $k=0$:
\begin{equation} \label{eq:no harm}
	P(\text{no }R,A,C\text{ in one hour}) = \exp \left\{ -\lambda \right\}.
\end{equation}


%Let $E$ be the final event that might result in a risky situation/harm. The probability $P$ of the exposure of a harm/risk in a certain scenario is then given by 
%\begin{equation}
%P(E,A_1,A_2,...A_n,C_1,C_2,..,C_m)=P(E,A,C) \label{eq:secM1}
%\end{equation}
%where $n$ is the number of performed activities within the scenario and $m$ is the number of conditions in the same scenario.
%Since the harm event $E$ depends on the performed actives and scenario conditions, to compute \ref{eq3} requires computing $P(A,C)$ first.
%\begin{equation}
%P(A,C)=P(A|C) \cdot P(C) \label{eq:secM2}
%\end{equation}
